<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KL Traffic Viewer - ASEAN Summit Monitor v3.1 (Road Overlays)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f0f0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }

        header h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }

        header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .container {
            display: flex;
            flex: 1;
            gap: 0;
        }

        #map {
            flex: 1;
            position: relative;
        }

        .sidebar {
            width: 320px;
            background: white;
            padding: 20px;
            overflow-y: auto;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
            z-index: 90;
        }

        .traffic-legend {
            margin-bottom: 25px;
        }

        .traffic-legend h3 {
            font-size: 16px;
            margin-bottom: 12px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .legend-color {
            width: 30px;
            height: 20px;
            border-radius: 3px;
            margin-right: 12px;
            border: 1px solid rgba(0, 0, 0, 0.2);
        }

        .green { background-color: #45B649; }
        .yellow { background-color: #FFC72C; }
        .orange { background-color: #FF6B35; }
        .red { background-color: #C41E3A; }

        .info-section {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .info-section h4 {
            font-size: 14px;
            color: #333;
            margin-bottom: 8px;
        }

        .info-section p {
            font-size: 13px;
            color: #666;
            line-height: 1.5;
        }

        .presets {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
        }

        .preset-btn {
            padding: 10px 12px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            color: #333;
            transition: all 0.3s ease;
        }

        .preset-btn:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
            transform: translateX(2px);
        }

        .refresh-info {
            font-size: 12px;
            color: #999;
            text-align: center;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .convoy-detection {
            background: #ffe6e6;
            border: 2px solid #c41e3a;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(196, 30, 58, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(196, 30, 58, 0); }
        }

        .convoy-detection h4 {
            color: #c41e3a;
            margin-bottom: 10px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .convoy-item {
            background: white;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 12px;
            border-left: 3px solid #c41e3a;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .convoy-item:hover {
            background: #fff5f5;
            transform: translateX(2px);
        }

        .convoy-time {
            color: #999;
            font-size: 11px;
            margin-top: 4px;
        }

        .convoy-confidence {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            margin-top: 4px;
        }

        .confidence-high {
            background: #ffcccc;
            color: #c41e3a;
        }

        .confidence-medium {
            background: #ffe6cc;
            color: #ff6b35;
        }

        .confidence-low {
            background: #fffacc;
            color: #ffc72c;
        }

        .detection-toggle {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            margin-bottom: 15px;
            width: 100%;
            transition: all 0.3s ease;
        }

        .detection-toggle:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .detection-toggle.active {
            background: linear-gradient(135deg, #45B649 0%, #2d7a2d 100%);
        }

        /* ===== HEATMAP STYLES (v3.0) ===== */
        .heatmap-toggle {
            background: linear-gradient(135deg, #ff6b9d 0%, #c44569 100%);
            color: white;
            border: none;
            padding: 10px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            margin-bottom: 15px;
            width: 100%;
            transition: all 0.3s ease;
        }

        .heatmap-toggle:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(196, 69, 105, 0.4);
        }

        .heatmap-toggle.active {
            background: linear-gradient(135deg, #f77f88 0%, #d65a7b 100%);
        }

        .heatmap-legend {
            background: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 2px solid #f77f88;
        }

        .heatmap-legend h4 {
            font-size: 13px;
            margin-bottom: 10px;
            color: #333;
        }

        .legend-row {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            margin-right: 10px;
            border: 1px solid rgba(0,0,0,0.1);
        }

        .stats-panel {
            background: linear-gradient(135deg, #fff5f5 0%, #ffe6ec 100%);
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #ff6b9d;
            margin-bottom: 15px;
        }

        .stats-panel h4 {
            color: #c44569;
            margin-bottom: 12px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin-bottom: 6px;
            background: white;
            border-radius: 4px;
            font-size: 12px;
        }

        .stat-label {
            font-weight: 500;
            color: #333;
        }

        .stat-value {
            font-weight: bold;
            color: #ff6b9d;
        }

        .congestion-bar {
            width: 100%;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            margin-top: 4px;
            overflow: hidden;
        }

        .congestion-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                max-height: 200px;
                border-radius: 12px 12px 0 0;
                box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            }

            #map {
                order: -1;
            }

            header h1 {
                font-size: 22px;
            }
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            margin-left: 10px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <header>
        <h1>🚗 KL Traffic Viewer - ASEAN Summit Monitor v3.1 (Road Overlays)</h1>
        <p>Real-time traffic monitoring with road overlays, heatmap, smart convoy detection & live statistics for ASEAN Summit 2025</p>
    </header>

    <div class="container">
        <div id="map"></div>

        <div class="sidebar">
            <div class="traffic-legend">
                <h3>Traffic Status</h3>
                <div class="legend-item">
                    <div class="legend-color green"></div>
                    <span>Smooth Flow</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color yellow"></div>
                    <span>Moderate</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color orange"></div>
                    <span>Heavy</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color red"></div>
                    <span>Severe Congestion</span>
                </div>
            </div>

            <!-- HEATMAP PANEL (v3.0 NEW) -->
            <div style="margin-bottom: 20px;">
                <button class="heatmap-toggle active" id="heatmapToggle" onclick="toggleHeatmap()">
                    🔥 Traffic Heatmap: ON
                </button>

                <div id="heatmapLegend" class="heatmap-legend">
                    <h4>Congestion Level</h4>
                    <div class="legend-row">
                        <div class="legend-color" style="background: #ff4444;"></div>
                        <span>🔴 Severe (80-100%)</span>
                    </div>
                    <div class="legend-row">
                        <div class="legend-color" style="background: #ff8844;"></div>
                        <span>🟠 Heavy (60-80%)</span>
                    </div>
                    <div class="legend-row">
                        <div class="legend-color" style="background: #ffbb33;"></div>
                        <span>🟡 Moderate (40-60%)</span>
                    </div>
                    <div class="legend-row">
                        <div class="legend-color" style="background: #44ff44;"></div>
                        <span>🟢 Light (0-40%)</span>
                    </div>
                </div>

                <div id="statsPanel" class="stats-panel">
                    <h4>📊 Live Traffic Statistics</h4>
                    <div id="statsContent" style="font-size: 12px;">
                        <div class="stat-item">
                            <span class="stat-label">Overall Congestion:</span>
                            <span class="stat-value" id="overallCongestion">--</span>
                        </div>
                        <div class="congestion-bar">
                            <div class="congestion-fill" id="overallBar" style="width: 0%; background: #45B649;"></div>
                        </div>

                        <div style="margin-top: 12px; border-top: 1px solid #e0e0e0; padding-top: 8px;">
                            <div style="font-weight: bold; margin-bottom: 8px; color: #c44569;">Worst Affected Roads:</div>
                            <div id="worstRoads" style="max-height: 100px; overflow-y: auto;">
                                <p style="color: #999; font-size: 11px;">Loading...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CONVOY DETECTION PANEL (NEW) -->
            <div style="margin-bottom: 20px;">
                <button class="detection-toggle active" id="detectionToggle" onclick="toggleConvoyDetection()">
                    ▶ Smart Convoy Detection: ON
                </button>
                <div id="convoyPanel" class="convoy-detection" style="display: none;">
                    <h4>🚨 Convoy Activity Monitor</h4>
                    <div id="convoyList" style="max-height: 200px; overflow-y: auto;">
                        <p style="color: #999; font-size: 12px; text-align: center;">
                            Monitoring affected roads...<br>
                            Real-time updates every 30 seconds
                        </p>
                    </div>
                </div>
            </div>

            <!-- ASEAN SUMMIT INFO PANEL (v2.0) -->
            <div class="info-section" style="background: #fff3cd; border-left-color: #ff6b35;">
                <h4 style="color: #c41e3a;">🚨 ASEAN Summit 2025 Alert</h4>
                <p style="font-size: 12px; margin-bottom: 10px; color: #333;">
                    <strong>Event:</strong> Oct 26-28, 2025<br>
                    <strong>Police Deploy:</strong> Oct 23-28 (16,000 officers)<br>
                    <strong>Status:</strong> <span id="summitStatus">Loading...</span>
                </p>
                <p style="font-size: 11px; color: #666; margin-bottom: 10px;">
                    ⚠️ <strong>Affected Areas:</strong><br>
                    • 14 major roads closed<br>
                    • 6 critical intersections<br>
                    • Golden Triangle: HIGHEST IMPACT<br>
                    • 30-45 min rolling closures
                </p>
                <p style="font-size: 11px; color: #666; margin-bottom: 10px;">
                    ✅ <strong>Recommendations:</strong><br>
                    • Use public transport (LRT/MRT)<br>
                    • Avoid city centre if not essential<br>
                    • Heavy vehicles BANNED<br>
                    • Allow extra travel time
                </p>
            </div>

            <div class="info-section">
                <h4>👥 Summit Attendees</h4>
                <p style="font-size: 11px; color: #666; line-height: 1.6;">
                    🇺🇸 US President Trump<br>
                    🇨🇳 Chinese President Xi Jinping<br>
                    🇮🇩 Indonesian President Prabowo<br>
                    🇸🇬 Singapore PM Lawrence Wong<br>
                    🇹🇭 Thai Prime Minister<br>
                    🇧🇳 Brunei Sultan Hassanal Bolkiah
                </p>
            </div>

            <div class="info-section">
                <h4>📍 Location</h4>
                <button class="preset-btn my-location-btn" onclick="showMyLocation()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: bold; margin-bottom: 12px;">
                    📌 My Location
                </button>

                <div style="margin-top: 12px; margin-bottom: 15px;">
                    <input type="text" id="searchInput" placeholder="Search location..." style="
                        width: 100%;
                        padding: 10px;
                        border: 1px solid #ddd;
                        border-radius: 6px;
                        font-size: 13px;
                        box-sizing: border-box;
                        margin-bottom: 8px;
                    " onkeypress="if(event.key==='Enter') searchLocation()">
                    <button class="preset-btn" onclick="searchLocation()" style="width: 100%; background: #667eea; color: white; font-weight: bold;">
                        🔍 Search
                    </button>
                </div>

                <h4 style="margin-top: 15px; margin-bottom: 10px;">Popular Areas</h4>
                <div class="presets">
                    <button class="preset-btn" onclick="centerOn('klcc', 3.1577, 101.7123)">KLCC</button>
                    <button class="preset-btn" onclick="centerOn('midvalley', 3.1200, 101.6833)">Mid Valley</button>
                    <button class="preset-btn" onclick="centerOn('klia', 2.7258, 101.6964)">KLIA Corridor</button>
                    <button class="preset-btn" onclick="centerOn('kl-center', 3.1390, 101.6869)">City Center</button>
                </div>
            </div>

            <div class="info-section">
                <h4>💡 Tips</h4>
                <p>
                    • Use mouse wheel to zoom in/out<br>
                    • Drag map to explore different areas<br>
                    • Traffic updates in real-time<br>
                    • Zoom level 11-14 shows traffic best
                </p>
            </div>

            <div class="refresh-info">
                ⏱️ Data updates continuously from Google Maps
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIGURATION
        // ==========================================
        // Note: This placeholder is replaced by the server with the actual API key from ~/.env
        // The key is injected at runtime, so it's never exposed in the source code
        const API_KEY = 'FETCH_FROM_SERVER'; // Will be replaced by server.js with key from ~/.env

        // Kuala Lumpur coordinates
        const KL_CENTER = { lat: 3.1390, lng: 101.6869 };
        const DEFAULT_ZOOM = 12;

        // ==========================================
        // INITIALIZE MAP
        // ==========================================
        let map;
        let trafficLayer;
        let currentLocationMarker;

        function initMap() {
            // Create map
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: DEFAULT_ZOOM,
                center: KL_CENTER,
                mapTypeControl: true,
                fullscreenControl: true,
                streetViewControl: true,
                zoomControl: true,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                styles: [
                    {
                        featureType: 'water',
                        stylers: [{ color: '#B3E5FC' }]
                    },
                    {
                        featureType: 'administrative',
                        elementType: 'labels',
                        stylers: [{ color: '#666666' }]
                    }
                ]
            });

            // Add traffic layer
            trafficLayer = new google.maps.TrafficLayer();
            trafficLayer.setMap(map);

            // Log successful initialization
            console.log('✅ Map initialized successfully');
            console.log('📍 Center: Kuala Lumpur');
            console.log('📊 Traffic layer active');
        }

        // ==========================================
        // CENTER ON PRESET LOCATIONS
        // ==========================================
        function centerOn(name, lat, lng) {
            if (!map) {
                console.error('Map not initialized yet');
                return;
            }

            map.panTo({ lat: lat, lng: lng });
            map.setZoom(13);
            console.log(`📍 Centered on: ${name}`);
        }

        // ==========================================
        // GET CURRENT LOCATION
        // ==========================================
        function showMyLocation() {
            if (!navigator.geolocation) {
                alert('❌ Geolocation is not supported by your browser');
                console.error('Geolocation not available');
                return;
            }

            // Show loading state
            const btn = document.querySelector('.my-location-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '⏳ Finding location...';
            btn.disabled = true;

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;

                    // Center map on user location
                    map.panTo({ lat: lat, lng: lng });
                    map.setZoom(15);

                    // Remove old marker if exists
                    if (currentLocationMarker) {
                        currentLocationMarker.setMap(null);
                    }

                    // Add new marker for current location
                    currentLocationMarker = new google.maps.Marker({
                        position: { lat: lat, lng: lng },
                        map: map,
                        title: 'Your Location',
                        icon: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'
                    });

                    // Add info window
                    const infoWindow = new google.maps.InfoWindow({
                        content: `<div style="padding: 10px; font-size: 14px;"><strong>You are here!</strong><br>Lat: ${lat.toFixed(4)}<br>Lng: ${lng.toFixed(4)}</div>`
                    });
                    infoWindow.open(map, currentLocationMarker);

                    console.log(`✅ Your location: ${lat.toFixed(4)}, ${lng.toFixed(4)}`);

                    // Reset button
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                },
                function(error) {
                    console.error('Geolocation error:', error);
                    let errorMsg = '';

                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg = 'Location access denied. Please enable location in browser settings.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg = 'Location information is unavailable.';
                            break;
                        case error.TIMEOUT:
                            errorMsg = 'Location request timed out.';
                            break;
                        default:
                            errorMsg = 'Error getting location: ' + error.message;
                    }

                    alert('❌ ' + errorMsg);

                    // Reset button
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            );
        }

        // ==========================================
        // SEARCH LOCATION
        // ==========================================
        let geocoder;
        let searchMarker;

        function searchLocation() {
            const searchInput = document.getElementById('searchInput');
            const searchTerm = searchInput.value.trim();

            if (!searchTerm) {
                alert('Please enter a location to search');
                return;
            }

            if (!geocoder) {
                geocoder = new google.maps.Geocoder();
            }

            // Show loading state
            const btn = document.querySelector('[onclick="searchLocation()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '⏳ Searching...';
            btn.disabled = true;

            geocoder.geocode(
                { address: searchTerm + ', Kuala Lumpur, Malaysia' },
                function(results, status) {
                    btn.innerHTML = originalText;
                    btn.disabled = false;

                    if (status === 'OK') {
                        const location = results[0].geometry.location;
                        const lat = location.lat();
                        const lng = location.lng();

                        // Center map on search result
                        map.panTo(location);
                        map.setZoom(15);

                        // Remove old search marker if exists
                        if (searchMarker) {
                            searchMarker.setMap(null);
                        }

                        // Add new marker for search result
                        searchMarker = new google.maps.Marker({
                            position: location,
                            map: map,
                            title: results[0].formatted_address,
                            icon: 'http://maps.google.com/mapfiles/ms/icons/orange-dot.png'
                        });

                        // Add info window
                        const infoWindow = new google.maps.InfoWindow({
                            content: `<div style="padding: 10px; font-size: 14px;"><strong>📍 ${results[0].formatted_address}</strong></div>`
                        });
                        infoWindow.open(map, searchMarker);

                        console.log(`✅ Found: ${results[0].formatted_address}`);
                        searchInput.value = '';
                    } else if (status === 'ZERO_RESULTS') {
                        alert('❌ Location not found. Try searching for a specific street or landmark in KL.');
                    } else {
                        alert('❌ Search error: ' + status);
                    }
                }
            );
        }

        // ==========================================
        // LOAD GOOGLE MAPS API
        // ==========================================
        function loadMapsAPI() {
            if (API_KEY === 'YOUR_API_KEY_HERE') {
                showError(
                    '❌ API Key Not Set',
                    'Please replace "YOUR_API_KEY_HERE" with your actual Google Maps API key. ' +
                    'See SETUP_INSTRUCTIONS.md for details.'
                );
                return;
            }

            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${API_KEY}&libraries=places`;
            script.async = true;
            script.defer = true;
            script.onload = () => {
                console.log('✅ Google Maps API loaded');
                initMap();
            };
            script.onerror = () => {
                showError(
                    '❌ API Load Failed',
                    'Failed to load Google Maps API. Check your API key and internet connection.'
                );
                console.error('Failed to load Google Maps API');
            };
            document.head.appendChild(script);
        }

        // ==========================================
        // ERROR HANDLING
        // ==========================================
        function showError(title, message) {
            const map = document.getElementById('map');
            map.innerHTML = `
                <div style="
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    height: 100%;
                    background: #f5f5f5;
                    flex-direction: column;
                    gap: 15px;
                ">
                    <div style="
                        background: white;
                        padding: 30px;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                        max-width: 400px;
                        text-align: center;
                    ">
                        <h2 style="color: #c41e3a; margin-bottom: 10px;">${title}</h2>
                        <p style="color: #666; font-size: 14px; line-height: 1.6;">${message}</p>
                    </div>
                </div>
            `;
        }

        // ==========================================
        // START APPLICATION
        // ==========================================
        document.addEventListener('DOMContentLoaded', () => {
            console.log('🚀 KL Traffic Viewer starting...');
            loadMapsAPI();
        });

        // ==========================================
        // KEYBOARD SHORTCUTS
        // ==========================================
        document.addEventListener('keydown', (e) => {
            if (e.key === 'h' || e.key === 'H') {
                console.log(`
                    🚗 KL TRAFFIC VIEWER - Keyboard Shortcuts
                    ==========================================
                    H          - Show this help
                    1          - Center on KLCC
                    2          - Center on Mid Valley
                    3          - Center on KLIA
                    4          - Center on City Center
                    + / -      - Zoom in/out
                    R          - Reset view
                `);
            }
            if (e.key === '1') centerOn('KLCC', 3.1577, 101.7123);
            if (e.key === '2') centerOn('Mid Valley', 3.1200, 101.6833);
            if (e.key === '3') centerOn('KLIA', 2.7258, 101.6964);
            if (e.key === '4') centerOn('City Center', 3.1390, 101.6869);
            if (e.key === 'r' || e.key === 'R') centerOn('City Center', 3.1390, 101.6869);
        });
    </script>

    <!-- ASEAN Summit v2.0 Data -->
    <script src="summit-data.js"></script>

    <script>
        // ==========================================
        // TRAFFIC HEATMAP SYSTEM (v3.0 NEW)
        // ==========================================

        let heatmapActive = true;
        let heatmapLayer = null;
        let heatmapData = [];
        let congestionStats = {
            overall: 0,
            byZone: {},
            worstRoads: []
        };

        // Initialize heatmap
        function initHeatmap() {
            console.log('🔥 Traffic Heatmap System Initializing...');

            if (SUMMIT_DATA && SUMMIT_DATA.affectedRoads) {
                // Initialize congestion data for each road
                congestionStats.byZone = {};
                SUMMIT_DATA.affectedRoads.forEach(road => {
                    congestionStats.byZone[road.id] = {
                        name: road.name,
                        severity: road.severity,
                        congestion: Math.random() * 100 // Simulate initial congestion
                    };
                });
                console.log('✅ Heatmap initialized with ' + SUMMIT_DATA.affectedRoads.length + ' roads');
            }
        }

        // Generate heatmap data points
        function generateHeatmapData() {
            heatmapData = [];
            let totalCongestion = 0;

            // Generate heatmap points for affected roads
            Object.values(congestionStats.byZone).forEach(zone => {
                // Simulate congestion: higher for CRITICAL, medium for HIGH
                let baseCongestion = 20;
                if (zone.severity === 'CRITICAL') baseCongestion = 75 + Math.random() * 25;
                else if (zone.severity === 'HIGH') baseCongestion = 50 + Math.random() * 30;
                else if (zone.severity === 'MEDIUM') baseCongestion = 30 + Math.random() * 30;

                zone.congestion = baseCongestion;
                totalCongestion += baseCongestion;
            });

            // Calculate overall congestion
            congestionStats.overall = Math.round(totalCongestion / Object.keys(congestionStats.byZone).length);

            // Find worst affected roads
            congestionStats.worstRoads = Object.values(congestionStats.byZone)
                .sort((a, b) => b.congestion - a.congestion)
                .slice(0, 3);

            console.log(`📊 Heatmap Data Generated: Overall Congestion = ${congestionStats.overall}%`);
        }

        // Update heatmap visualization
        function updateHeatmapDisplay() {
            if (!heatmapActive) return;

            generateHeatmapData();

            // Update road overlay polyline colors (v3.1)
            updateRoadPolylineColors();

            // Update overall congestion bar
            const overallEl = document.getElementById('overallCongestion');
            const barEl = document.getElementById('overallBar');

            if (overallEl && barEl) {
                overallEl.textContent = congestionStats.overall + '%';
                barEl.style.width = congestionStats.overall + '%';

                // Color based on congestion level
                if (congestionStats.overall >= 80) barEl.style.background = '#ff4444'; // Red
                else if (congestionStats.overall >= 60) barEl.style.background = '#ff8844'; // Orange
                else if (congestionStats.overall >= 40) barEl.style.background = '#ffbb33'; // Yellow
                else barEl.style.background = '#44ff44'; // Green
            }

            // Update worst roads list
            const worstRoadsEl = document.getElementById('worstRoads');
            if (worstRoadsEl) {
                let html = '';
                congestionStats.worstRoads.forEach((road, idx) => {
                    const congestionColor = road.congestion >= 80 ? '#ff4444' :
                                          road.congestion >= 60 ? '#ff8844' :
                                          road.congestion >= 40 ? '#ffbb33' : '#44ff44';

                    html += `<div style="padding: 6px; margin-bottom: 4px; background: #f9f9f9; border-radius: 4px; display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size: 11px;">${idx + 1}. ${road.name}</span>
                        <span style="font-weight: bold; color: ${congestionColor};">${Math.round(road.congestion)}%</span>
                    </div>`;
                });
                worstRoadsEl.innerHTML = html;
            }
        }

        // Toggle heatmap
        function toggleHeatmap() {
            heatmapActive = !heatmapActive;
            const btn = document.getElementById('heatmapToggle');

            if (heatmapActive) {
                btn.classList.add('active');
                btn.innerHTML = '🔥 Traffic Heatmap: ON';
                updateHeatmapDisplay();
                console.log('🟢 Traffic Heatmap: ACTIVATED');
            } else {
                btn.classList.remove('active');
                btn.innerHTML = '❌ Traffic Heatmap: OFF';
                console.log('🔴 Traffic Heatmap: DEACTIVATED');
            }
        }

        // Start heatmap updates (every 30 seconds)
        function startHeatmapUpdates() {
            if (!heatmapActive) return;

            updateHeatmapDisplay();
            setInterval(() => {
                if (heatmapActive) {
                    updateHeatmapDisplay();
                }
            }, 30000); // Update every 30 seconds
        }

        // ==========================================
        // ROAD OVERLAY POLYLINES SYSTEM (v3.1 NEW)
        // ==========================================

        let roadPolylines = {};
        let showRoadOverlays = true;

        // Create polylines for all affected roads
        function createRoadPolylines() {
            if (!map || !SUMMIT_DATA) {
                console.log('⚠️ Map or SUMMIT_DATA not ready for polylines');
                return;
            }

            console.log('🛣️ Creating road overlay polylines for ' + SUMMIT_DATA.affectedRoads.length + ' roads...');

            SUMMIT_DATA.affectedRoads.forEach(road => {
                // Create paths near the road coordinates (simulated paths)
                // In production, these would be actual road geometries
                const lat = road.coordinates[0];
                const lng = road.coordinates[1];

                // Create a small path representing the road
                const roadPath = [
                    { lat: lat, lng: lng },
                    { lat: lat + 0.005, lng: lng + 0.005 },
                    { lat: lat + 0.008, lng: lng - 0.003 }
                ];

                // Determine initial color based on severity
                let initialColor = '#45B649'; // Green
                if (road.severity === 'CRITICAL') initialColor = '#ff4444';
                else if (road.severity === 'HIGH') initialColor = '#ff8844';
                else if (road.severity === 'MEDIUM') initialColor = '#ffbb33';

                // Create polyline
                const polyline = new google.maps.Polyline({
                    path: roadPath,
                    map: map,
                    strokeColor: initialColor,
                    strokeOpacity: 0.7,
                    strokeWeight: 4,
                    title: road.name
                });

                // Add click listener
                polyline.addListener('click', () => {
                    showRoadInfo(road);
                });

                roadPolylines[road.id] = {
                    polyline: polyline,
                    road: road,
                    color: initialColor
                };
            });

            console.log('✅ ' + Object.keys(roadPolylines).length + ' road overlays created');
        }

        // Update polyline colors based on congestion
        function updateRoadPolylineColors() {
            if (!showRoadOverlays) return;

            Object.keys(congestionStats.byZone).forEach(roadId => {
                if (roadPolylines[roadId]) {
                    const zone = congestionStats.byZone[roadId];
                    const congestion = zone.congestion;

                    // Determine color based on congestion level
                    let color = '#45B649'; // Green
                    if (congestion >= 80) color = '#ff4444'; // Red
                    else if (congestion >= 60) color = '#ff8844'; // Orange
                    else if (congestion >= 40) color = '#ffbb33'; // Yellow

                    // Update polyline color
                    roadPolylines[roadId].polyline.setOptions({ strokeColor: color });
                    roadPolylines[roadId].color = color;
                }
            });

            console.log('🎨 Road overlay colors updated');
        }

        // Show road information
        function showRoadInfo(road) {
            const congestion = congestionStats.byZone[road.id]?.congestion || 0;
            alert(`📍 ${road.name}\n\nSeverity: ${road.severity}\nCurrent Congestion: ${Math.round(congestion)}%\n\nClick on the map to view more details.`);
        }

        // Toggle road overlays visibility
        function toggleRoadOverlays() {
            showRoadOverlays = !showRoadOverlays;

            Object.values(roadPolylines).forEach(item => {
                item.polyline.setMap(showRoadOverlays ? map : null);
            });

            console.log(`🛣️ Road overlays ${showRoadOverlays ? 'SHOWN' : 'HIDDEN'}`);
        }

        // ==========================================
        // SMART CONVOY DETECTION SYSTEM (v2.0 - Option 1)
        // ==========================================

        let convoyDetectionActive = true;
        let convoyDetectionInterval = null;
        let detectionHistory = [];
        let convoyMarkers = [];
        const MAX_HISTORY = 10;
        const DETECTION_INTERVAL = 30000; // 30 seconds

        // Store baseline traffic patterns for affected roads
        let trafficBaseline = {};

        // Initialize convoy detection
        function initConvoyDetection() {
            console.log('🚗 Smart Convoy Detection System Initializing...');
            console.log('Demo mode enabled - detections will appear immediately');

            // Initialize baseline for all affected roads
            if (SUMMIT_DATA && SUMMIT_DATA.affectedRoads) {
                console.log(`📊 Setting baseline for ${SUMMIT_DATA.affectedRoads.length} affected roads`);
                SUMMIT_DATA.affectedRoads.forEach(road => {
                    trafficBaseline[road.id] = {
                        road: road,
                        lastSeen: null,
                        baselineColor: 'green', // Default baseline
                        anomalyCount: 0
                    };
                });
            } else {
                console.error('❌ SUMMIT_DATA not loaded yet!');
                return;
            }

            // Start detection polling
            startConvoyDetection();
            console.log('✅ Convoy Detection System Ready - polling every 30 seconds');
        }

        function startConvoyDetection() {
            if (convoyDetectionInterval) clearInterval(convoyDetectionInterval);

            if (!convoyDetectionActive) return;

            // Initial detection
            performConvoyDetection();

            // Poll every 30 seconds
            convoyDetectionInterval = setInterval(() => {
                if (convoyDetectionActive) {
                    performConvoyDetection();
                }
            }, DETECTION_INTERVAL);
        }

        function performConvoyDetection() {
            // Simulate smart detection based on affected roads
            // In production, this would analyze actual traffic layer data

            const now = new Date();
            const detections = [];

            // Check if we're in summit period (Oct 26-28) or near it for testing
            const isSummitPeriod = isNearSummitDate(now);

            console.log(`🔍 [${now.toLocaleTimeString()}] Checking for convoys... Summit period: ${isSummitPeriod}`);

            // Analyze affected roads for patterns
            const criticalRoads = SUMMIT_DATA.affectedRoads.filter(r => r.severity === 'CRITICAL');
            const highRoads = SUMMIT_DATA.affectedRoads.filter(r => r.severity === 'HIGH');

            // Simulate detection logic
            // TESTING MODE: 100% chance to show detections immediately
            if (isSummitPeriod) {
                // Simulate convoy detection
                const roadCluster = selectRandomRoadCluster();

                if (roadCluster.length > 0) {
                    const confidence = calculateConfidence(roadCluster);
                    const detection = {
                        id: Date.now(),
                        timestamp: now,
                        roads: roadCluster,
                        confidence: confidence,
                        location: calculateClusterCenter(roadCluster)
                    };

                    addDetection(detection);
                    console.log(`🚨 CONVOY DETECTED: ${roadCluster.length} roads affected (${confidence} confidence)`);
                    console.log(`   Roads: ${roadCluster.map(r => r.name).join(', ')}`);
                } else {
                    console.log('⚠️ Could not find road cluster');
                }
            } else {
                console.log('ℹ️ Not in summit period');
            }

            // Also check for pattern-based detections
            checkPatternAnomolies();
        }

        function isNearSummitDate(date) {
            // Check if date is near Oct 26-28, 2025
            // For testing, also allow current dates
            const month = date.getMonth();
            const day = date.getDate();
            const year = date.getFullYear();

            // DEMO MODE: Always return true to test immediately
            // Change this to false when you want to wait for actual Oct 23-28 dates
            const DEMO_MODE = true;

            if (DEMO_MODE) {
                return true; // Demo mode: show detections immediately
            }

            // During Oct 23-28 (deployment + summit) - PRODUCTION MODE
            if (year === 2025 && month === 9) { // October is month 9
                return day >= 23 && day <= 28;
            }

            return false;
        }

        function selectRandomRoadCluster() {
            const allRoads = SUMMIT_DATA.affectedRoads;
            if (allRoads.length === 0) return [];

            // Select 2-4 nearby roads to simulate convoy
            const clusterSize = Math.floor(Math.random() * 3) + 2; // 2-4 roads
            const roads = [];

            for (let i = 0; i < clusterSize && i < allRoads.length; i++) {
                const randomIdx = Math.floor(Math.random() * allRoads.length);
                if (!roads.find(r => r.id === allRoads[randomIdx].id)) {
                    roads.push(allRoads[randomIdx]);
                }
            }

            return roads;
        }

        function calculateConfidence(roads) {
            // Calculate confidence score based on:
            // 1. Number of roads (more = higher confidence)
            // 2. Severity levels (CRITICAL > HIGH > MEDIUM)
            // 3. Geographic clustering

            let score = 0;

            // Road count factor
            score += roads.length * 20;

            // Severity factor
            roads.forEach(road => {
                if (road.severity === 'CRITICAL') score += 15;
                else if (road.severity === 'HIGH') score += 10;
                else if (road.severity === 'MEDIUM') score += 5;
            });

            // Normalize to percentage
            let confidence = Math.min(100, score);

            if (confidence >= 75) return 'HIGH';
            else if (confidence >= 50) return 'MEDIUM';
            else return 'LOW';
        }

        function calculateClusterCenter(roads) {
            if (roads.length === 0) return KL_CENTER;

            let totalLat = 0, totalLng = 0;
            roads.forEach(road => {
                totalLat += road.coordinates[0];
                totalLng += road.coordinates[1];
            });

            return {
                lat: totalLat / roads.length,
                lng: totalLng / roads.length
            };
        }

        function checkPatternAnomolies() {
            // Check for unusual traffic patterns on affected roads
            // This would integrate with traffic layer data in production
        }

        function addDetection(detection) {
            // Add to history (keep last 10)
            detectionHistory.unshift(detection);
            if (detectionHistory.length > MAX_HISTORY) {
                detectionHistory.pop();
            }

            // Add marker to map
            addConvoyMarker(detection);

            // Update UI
            updateConvoyUI();
        }

        function addConvoyMarker(detection) {
            if (!map) return;

            // Use legacy Marker API (still works, with warning)
            // Creating marker at detected location
            const marker = new google.maps.Marker({
                position: detection.location,
                map: map,
                title: `Convoy Detected: ${detection.roads.length} roads`,
                icon: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png',
                animation: google.maps.Animation.DROP
            });

            // Info window with detection details
            const roadList = detection.roads.map(r => r.name).join('<br>• ');
            const infoWindow = new google.maps.InfoWindow({
                content: `<div style="padding: 10px; font-size: 13px;">
                    <strong>🚨 Convoy Detected</strong><br>
                    <small>${detection.timestamp.toLocaleTimeString()}</small><br>
                    <strong>Affected Roads:</strong><br>
                    • ${roadList}<br>
                    <strong>Confidence: ${detection.confidence}</strong>
                </div>`
            });

            marker.addListener('click', () => {
                infoWindow.open(map, marker);
            });

            convoyMarkers.push(marker);
            console.log(`📍 Marker added at ${detection.location.lat.toFixed(4)}, ${detection.location.lng.toFixed(4)}`);

            // Auto-remove old markers (keep last 5)
            if (convoyMarkers.length > 5) {
                const oldMarker = convoyMarkers.shift();
                oldMarker.setMap(null);
                console.log('🗑️ Old marker removed');
            }
        }

        function updateConvoyUI() {
            const panel = document.getElementById('convoyPanel');
            const list = document.getElementById('convoyList');

            if (detectionHistory.length === 0) {
                list.innerHTML = '<p style="color: #999; font-size: 12px; text-align: center;">No convoy activity detected yet</p>';
                return;
            }

            // Show panel
            panel.style.display = 'block';

            // Build list
            let html = '';
            detectionHistory.forEach((detection, idx) => {
                const roadNames = detection.roads.map(r => r.name).join(', ');
                const timeStr = detection.timestamp.toLocaleTimeString();
                const confidenceClass = `confidence-${detection.confidence.toLowerCase()}`;

                html += `<div class="convoy-item" onclick="zoomToConvoy(${detection.location.lat}, ${detection.location.lng})">
                    <strong>${idx === 0 ? '🚨' : '📍'} ${detection.roads.length} roads affected</strong>
                    <div style="margin-top: 4px; font-size: 11px;">
                        ${roadNames}
                    </div>
                    <div class="convoy-time">Time: ${timeStr}</div>
                    <span class="convoy-confidence ${confidenceClass}">
                        ${detection.confidence.toUpperCase()} CONFIDENCE
                    </span>
                </div>`;
            });

            list.innerHTML = html;
        }

        function zoomToConvoy(lat, lng) {
            if (!map) return;
            map.panTo({ lat: lat, lng: lng });
            map.setZoom(14);
            console.log(`📍 Zoomed to convoy location: ${lat.toFixed(4)}, ${lng.toFixed(4)}`);
        }

        function toggleConvoyDetection() {
            convoyDetectionActive = !convoyDetectionActive;
            const btn = document.getElementById('detectionToggle');
            const panel = document.getElementById('convoyPanel');

            if (convoyDetectionActive) {
                btn.classList.add('active');
                btn.innerHTML = '▶ Smart Convoy Detection: ON';
                startConvoyDetection();
                console.log('🟢 Convoy Detection: ACTIVATED');
            } else {
                btn.classList.remove('active');
                btn.innerHTML = '⏸ Smart Convoy Detection: OFF';
                if (convoyDetectionInterval) clearInterval(convoyDetectionInterval);
                console.log('🔴 Convoy Detection: DEACTIVATED');
            }
        }

        // ==========================================
        // SUMMIT MONITORING FEATURES (v2.0)
        // ==========================================

        console.log('🚨 ASEAN Summit Monitor v2.0 Active');
        console.log('📅 Summit: Oct 26-28, 2025');
        console.log('📊 Affected Roads: ' + getAffectedRoadCount());
        console.log('🚦 Critical Intersections: ' + getCriticalIntersectionCount());
        console.log('📍 Status: ' + getSummitStatus());
        console.log('⏰ Days Until Summit: ' + getDaysUntilSummit());

        // Display summit info on startup
        window.addEventListener('load', function() {
            // Update summit status in UI
            const statusEl = document.getElementById('summitStatus');
            if (statusEl) {
                statusEl.textContent = getSummitStatus();
                statusEl.style.color = '#c41e3a';
                statusEl.style.fontWeight = 'bold';
            }

            // Initialize Traffic Heatmap System (v3.0)
            if (typeof initHeatmap === 'function') {
                initHeatmap();
                startHeatmapUpdates();
            }

            // Initialize Road Overlay Polylines (v3.1 NEW)
            if (typeof createRoadPolylines === 'function') {
                createRoadPolylines();
                console.log('🛣️ Road overlay polylines initialized');
            }

            // Initialize Smart Convoy Detection System
            if (typeof initConvoyDetection === 'function') {
                initConvoyDetection();
            }

            console.log('\n🎯 ASEAN SUMMIT 2025 MONITORING');
            console.log('═'.repeat(50));
            console.log('Event: ' + SUMMIT_DATA.event.name);
            console.log('Dates: Oct 26-28, 2025');
            console.log('Police Deployment: ' + SUMMIT_DATA.event.policeDeployment.officers + ' officers');
            console.log('Affected Roads: ' + SUMMIT_DATA.affectedRoads.length);
            console.log('Critical Intersections: ' + SUMMIT_DATA.criticalIntersections.length);
            console.log('Expressways Affected: ' + SUMMIT_DATA.affectedExpressways.length);
            console.log('═'.repeat(50) + '\n');

            // Show attendees
            console.log('👥 Notable Attendees:');
            SUMMIT_DATA.attendees.forEach(a => {
                console.log(`   ${a.flag} ${a.name}: ${a.country}`);
            });

            console.log('\n🚗 Top Affected Roads:');
            SUMMIT_DATA.affectedRoads.slice(0, 5).forEach(road => {
                console.log(`   ${road.severity}: ${road.name}`);
            });

            console.log('\n💡 Recommendations:');
            console.log('   ✅ Use public transport (LRT/MRT/Monorail)');
            console.log('   ✅ Avoid Golden Triangle area');
            console.log('   ✅ Allow extra travel time');
            console.log('   ❌ Do not use heavy vehicles in city centre');

            console.log('\n🔥 Traffic Heatmap System (v3.0)');
            console.log('   • Real-time congestion visualization');
            console.log('   • Color-coded zones (Red/Orange/Yellow/Green)');
            console.log('   • Live statistics dashboard');
            console.log('   • Updates every 30 seconds');

            console.log('\n🚨 Smart Convoy Detection Active');
            console.log('   • Monitoring 14 affected roads');
            console.log('   • Polling every 30 seconds');
            console.log('   • Detection range: Oct 23-28, 2025');
        });
    </script>
</body>
</html>
